<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Panel | Pink Rentals</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        const u = localStorage.parse = localStorage.getItem('pinkUser');
        if(!u) window.location.href = 'login.html';
    </script>
    
    <style>
        /* CSS Espec√≠fico para el Layout de Checkout */
        .checkout-layout { display: grid; grid-template-columns: 1fr 380px; gap: 30px; }
        
        /* Formulario Pegajoso (Sticky) a la derecha */
        .sticky-form-card {
            background: #1e1e1e; padding: 25px; border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: sticky; top: 100px; /* Se queda fijo bajo el header */
        }
        
        /* Tarjetas de Items en el carrito */
        .cart-item-card {
            background: #1e1e1e; padding: 20px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);
        }
        .cart-price { font-size: 1.1rem; font-weight: 700; color: var(--pink-primary); }
        .input-dark { width: 100%; background: #121212; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; margin-top: 5px; }
        
        @media (max-width: 900px) { .checkout-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="theme-dark">
    
    <header class="header">
        <div class="container header-inner">
            <div class="logo">
                <h1><span class="pink-text">Pink</span> Rentals</h1>
                <p class="tagline">CLIENTE</p>
            </div>
            <nav class="nav"><ul></ul></nav>
            <div class="header-user-area">
                <span id="userDisplay" style="font-size:0.85rem; color:#aaa;"></span>
                <div id="authButtonContainer"></div>
                <button id="theme-toggle" class="theme-toggle" onclick="document.body.classList.toggle('theme-light')">üåì</button>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 120px; padding-bottom: 60px; min-height: 80vh;">
        
        <div id="view-checkout" style="display: none;">
            <div class="section-title text-center" style="margin-bottom: 40px;">
                <h2>Confirmar <span class="pink-text">Reserva</span></h2>
                <p>Revisa tus servicios seleccionados y completa los detalles.</p>
            </div>

            <div class="checkout-layout">
                <div class="checkout-items">
                    <div style="background: rgba(255,20,147,0.1); border-left: 4px solid #FF1493; padding: 15px; border-radius: 4px; margin-bottom: 25px; display: flex; gap: 15px; align-items: center;">
                        <span style="font-size: 24px;">üí°</span>
                        <div style="font-size: 0.9rem; color: #ffcfe6;">
                            Has agregado estos items a tu lista. Para a√±adir m√°s, visita <a href="servicios.html" style="color:#fff; text-decoration:underline;">Servicios</a>.
                        </div>
                    </div>

                    <div id="cart-container"></div>

                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333; padding-top: 20px;">
                        <h3>Total Estimado:</h3>
                        <h2 class="pink-text" id="cart-total">‚Ç°0</h2>
                    </div>
                </div>

                <div class="checkout-form">
                    <div class="sticky-form-card">
                        <h3 style="margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">Datos del Evento</h3>
                        <form id="form-checkout">
                            <div style="margin-bottom: 15px;">
                                <label style="color:#ccc; font-size: 0.85rem;">Fecha del Evento</label>
                                <input type="date" id="fecha" class="input-dark" required>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="color:#ccc; font-size: 0.85rem;">Inicio</label>
                                    <input type="time" id="horaInicio" class="input-dark" required>
                                </div>
                                <div>
                                    <label style="color:#ccc; font-size: 0.85rem;">Fin</label>
                                    <input type="time" id="horaFin" class="input-dark" required>
                                </div>
                            </div>

                            <div style="margin-bottom: 25px;">
                                <label style="color:#ccc; font-size: 0.85rem;">Ubicaci√≥n / Direcci√≥n</label>
                                <select id="selectDireccion" class="input-dark" required>
                                    <option value="">Cargando...</option>
                                </select>
                                <small style="color:#666; font-size:0.75rem; display:block; margin-top:5px;">* Direcci√≥n registrada en tu perfil.</small>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 1rem; border-radius: 8px;">
                                ‚úÖ FINALIZAR SOLICITUD
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" style="display: none;">
            <div class="section-title text-center" style="margin-bottom: 40px;">
                <h2>Mis <span class="pink-text">Eventos</span></h2>
                <p>Historial y estado de tus reservaciones.</p>
            </div>
            
            <div id="lista-reservas-container" style="max-width: 800px; margin: 0 auto;">
                <p class="text-center">Cargando...</p>
            </div>
        </div>

    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom"><p>&copy; 2025 Pink Rentals.</p></div>
        </div>
    </footer>

    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('pinkUser'));
            
            // Detectar vista por URL (ej: ?view=history)
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view') || 'checkout';
            
            toggleView(view);
            cargarDirecciones(user.cedula);

            // Listener carrito
            window.addEventListener('cartUpdated', renderCart);
            renderCart();

            document.getElementById('form-checkout').addEventListener('submit', procesarReserva);
        });

        function toggleView(viewName) {
            document.getElementById('view-checkout').style.display = viewName === 'checkout' ? 'block' : 'none';
            document.getElementById('view-history').style.display = viewName === 'history' ? 'block' : 'none';
            if(viewName === 'history') cargarHistorial();
        }

        async function cargarDirecciones(cedula) {
            try {
                const direcciones = await ApiService.getDirecciones();
                const select = document.getElementById('selectDireccion');
                select.innerHTML = '<option value="">Selecciona ubicaci√≥n...</option>';
                
                const misDirecciones = direcciones.filter(d => String(d.usuarios_id_cedula_pk).trim() == String(cedula).trim());
                // Fallback: si es demo y no tiene direcciones propias, mostrar todas
                const lista = misDirecciones.length > 0 ? misDirecciones : direcciones; 
                
                lista.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.direcciones_id_direccion_pk;
                    opt.textContent = d.descripcion;
                    select.appendChild(opt);
                });
            } catch(e) { console.error(e); }
        }

        function renderCart() {
            const cart = CartSystem.get();
            const container = document.getElementById('cart-container');
            const totalEl = document.getElementById('cart-total');
            
            if(cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; border:1px dashed #444; border-radius:10px; color:#666;">
                        <p style="font-size:30px; margin-bottom:10px;">üõí</p>
                        <p>Tu carrito est√° vac√≠o.</p>
                        <a href="servicios.html" class="btn btn-primary" style="margin-top:15px; display:inline-block; font-size:0.8rem;">Explorar Cat√°logo</a>
                    </div>`;
                totalEl.textContent = '‚Ç°0';
                return;
            }

            container.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                total += parseFloat(item.precio);
                const tipoIcono = item.tipo === 'servicio' ? 'üì∏' : 'üì¶';
                
                const card = document.createElement('div');
                card.className = 'cart-item-card';
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="font-size:24px; background:#333; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border-radius:10px;">${tipoIcono}</div>
                        <div>
                            <h4 style="margin:0; font-size:1rem;">${item.nombre}</h4>
                            <p style="margin:0; font-size:0.8rem; color:#888;">${item.tipo.toUpperCase()}</p>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="cart-price">‚Ç°${Number(item.precio).toLocaleString()}</div>
                        <button class="btn-remove-cart" onclick="CartSystem.remove(${index})" style="color:#f44336; background:none; border:none; cursor:pointer; font-size:0.8rem; margin-top:5px; text-decoration:underline;">Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
            totalEl.textContent = '‚Ç°' + total.toLocaleString();
        }

        async function procesarReserva(e) {
            e.preventDefault();
            const cart = CartSystem.get();
            if(cart.length === 0) return alert("Agrega servicios al carrito primero.");
            const user = JSON.parse(localStorage.getItem('pinkUser'));
            
            // Aqu√≠ ir√≠a la l√≥gica real de env√≠o al backend
            console.log("Enviando Reserva...", { items: cart, fecha: document.getElementById('fecha').value });
            
            alert("üéâ ¬°Solicitud Enviada! \nNos pondremos en contacto para confirmar.");
            CartSystem.clear();
            window.location.href = '?view=history';
        }

        async function cargarHistorial() {
            const container = document.getElementById('lista-reservas-container');
            const user = JSON.parse(localStorage.getItem('pinkUser'));
            container.innerHTML = '<p class="text-center">Cargando...</p>';

            try {
                const reservas = await ApiService.getReservaciones();
                const mis = reservas.filter(r => String(r.usuarios_id_cedula_pk).trim() === String(user.cedula).trim());
                mis.sort((a,b) => new Date(b.fecha_reservacion) - new Date(a.fecha_reservacion));

                if(mis.length === 0) {
                    container.innerHTML = '<p class="text-center" style="color:#888;">No tienes historial de eventos.</p>';
                    return;
                }

                let html = '';
                mis.forEach(r => {
                    // Estados: 3=Pendiente, 4=Confirmada, 5=Cancelada
                    const estadoMap = {
                        3: {t:'Pendiente', c:'#FFB300', bg:'rgba(255, 179, 0, 0.1)'},
                        4: {t:'Confirmada', c:'#4CAF50', bg:'rgba(76, 175, 80, 0.1)'},
                        5: {t:'Cancelada', c:'#F44336', bg:'rgba(244, 67, 54, 0.1)'}
                    };
                    const st = estadoMap[r.estados_id_estado_pk] || {t:'Desconocido', c:'#777', bg:'#222'};

                    html += `
                    <div style="background:#1e1e1e; padding:20px; border-radius:12px; margin-bottom:15px; border-left: 5px solid ${st.c}; display:flex; justify-content:space-between; align-items:center; border:1px solid #333;">
                        <div>
                            <h3 style="margin:0 0 5px 0;">Reserva #${r.reservaciones_id_reservacion_pk}</h3>
                            <p style="margin:0; color:#aaa; font-size:0.9rem;">
                                üìÖ ${new Date(r.fecha_reservacion).toLocaleDateString()} &nbsp;|&nbsp; 
                                ‚è∞ ${r.hora_inicio ? r.hora_inicio.substring(0,5) : '--:--'}
                            </p>
                        </div>
                        <div>
                            <span style="background:${st.bg}; color:${st.c}; padding:6px 15px; border-radius:20px; font-weight:bold; font-size:0.8rem; border:1px solid ${st.c};">
                                ${st.t.toUpperCase()}
                            </span>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<p class="text-center error">Error cargando historial.</p>'; }
        }
    </script>
</body>
</html>