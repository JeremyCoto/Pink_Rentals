<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Panel | Pink Rentals</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Layout espec√≠fico */
        .dashboard-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; min-height: 80vh; }
        .sidebar { background: #2d2d2d; padding: 20px; border-radius: 10px; }
        .sidebar button { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: transparent; border: 1px solid #444; color: #ccc; text-align: left; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .sidebar button.active { background: #ff4081; color: white; border-color: #ff4081; }
        .sidebar button:hover:not(.active) { background: #333; }
        
        .content-area { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        
        /* Marketplace */
        .marketplace-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .item-card { display: flex; justify-content: space-between; align-items: center; background: #383838; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .item-info h4 { margin: 0; color: white; }
        .btn-add { background: #4caf50; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; }
        
        /* Mis Reservas */
        .reserva-card { background: #2d2d2d; padding: 15px; margin-bottom: 15px; border-left: 4px solid #ff4081; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .badge-pendiente { background: #ff9800; color: black; }
        .badge-confirmado { background: #4caf50; color: white; }
        .badge-cancelado { background: #f44336; color: white; }
    </style>
</head>
<body class="theme-dark">
    
    <div class="container" style="margin-top: 20px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2>Hola, <span id="userName" class="pink-text">Cliente</span></h2>
                <p style="color: #888;">Gestiona tus eventos</p>
            </div>
            <div>
                <a href="index.html" class="btn" style="background: #444; color: white; text-decoration: none; padding: 10px 20px; margin-right: 10px;">‚Üê Volver al Inicio</a>
                <button onclick="logout()" class="btn" style="border: 1px solid #666; background: transparent; color: #ccc;">Cerrar Sesi√≥n</button>
            </div>
        </header>

        <div class="dashboard-layout">
            <!-- Sidebar Navegaci√≥n -->
            <div class="sidebar">
                <button onclick="mostrarSeccion('nueva')" id="btn-nueva" class="active">üõí Nueva Reserva</button>
                <button onclick="mostrarSeccion('mis')" id="btn-mis">üìÖ Mis Reservaciones</button>
            </div>

            <!-- √Årea de Contenido -->
            <div class="content-area">
                
                <!-- SECCI√ìN 1: NUEVA RESERVA -->
                <div id="sec-nueva">
                    <div class="marketplace-grid">
                        <!-- Cat√°logo -->
                        <div>
                            <h3 style="margin-bottom: 15px;">Cat√°logo</h3>
                            <div style="margin-bottom: 15px;">
                                <button onclick="filtrarCatalogo('servicio')" style="margin-right: 5px; padding: 5px 10px; cursor: pointer;">Servicios</button>
                                <button onclick="filtrarCatalogo('producto')" style="padding: 5px 10px; cursor: pointer;">Productos Extra</button>
                            </div>
                            <div id="catalogContainer" style="height: 400px; overflow-y: auto;"></div>
                        </div>

                        <!-- Carrito y Checkout -->
                        <div style="background: #252525; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #ff4081;">Resumen</h3>
                            
                            <div style="margin: 15px 0;">
                                <label style="display:block; font-size: 0.85rem; color: #aaa;">Fecha Evento</label>
                                <input type="date" id="fecha" class="form-control" style="width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px;">
                                
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <div style="flex: 1;">
                                        <label style="display:block; font-size: 0.85rem; color: #aaa;">Inicio</label>
                                        <input type="time" id="horaInicio" style="width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="display:block; font-size: 0.85rem; color: #aaa;">Fin</label>
                                        <input type="time" id="horaFin" style="width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px;">
                                    </div>
                                </div>

                                <label style="display:block; font-size: 0.85rem; color: #aaa; margin-top: 10px;">Ubicaci√≥n (Direcci√≥n)</label>
                                <select id="selectDireccion" style="width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px;">
                                    <option value="">Cargando direcciones...</option>
                                </select>
                            </div>

                            <div id="cartItems" style="border-top: 1px solid #444; border-bottom: 1px solid #444; padding: 10px 0; min-height: 100px; margin-bottom: 10px;">
                                <p style="color: #666; text-align: center; font-size: 0.9rem;">Carrito vac√≠o</p>
                            </div>

                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem;">
                                <span>Total:</span>
                                <span id="cartTotal">‚Ç°0</span>
                            </div>

                            <button onclick="realizarCheckout()" id="btnCheckout" style="width: 100%; background: #ff4081; color: white; border: none; padding: 10px; margin-top: 15px; border-radius: 5px; font-weight: bold; cursor: pointer;">Confirmar Reserva</button>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 2: MIS RESERVACIONES -->
                <div id="sec-mis" style="display: none;">
                    <h3>Historial de Eventos</h3>
                    <div id="lista-mis-reservas">
                        <p>Cargando...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let cart = [];
        let catalog = [];

        // INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('pinkUser');
            if(!userStr) window.location.href = 'login.html';
            currentUser = JSON.parse(userStr);
            document.getElementById('userName').textContent = currentUser.nombre;

            await cargarDatos();
            await cargarMisReservas();
        });

        function logout() {
            localStorage.removeItem('pinkUser');
            window.location.href = 'index.html';
        }

        function mostrarSeccion(sec) {
            document.getElementById('sec-nueva').style.display = sec === 'nueva' ? 'block' : 'none';
            document.getElementById('sec-mis').style.display = sec === 'mis' ? 'block' : 'none';
            document.getElementById('btn-nueva').classList.toggle('active', sec === 'nueva');
            document.getElementById('btn-mis').classList.toggle('active', sec === 'mis');
            
            if(sec === 'mis') cargarMisReservas();
        }

        async function cargarDatos() {
            try {
                const [servicios, productos, direcciones] = await Promise.all([
                    fetch('http://localhost:3000/api/servicios').then(r => r.json()),
                    fetch('http://localhost:3000/api/productos').then(r => r.json()),
                    fetch('http://localhost:3000/api/direcciones').then(r => r.json())
                ]);

                // Llenar cat√°logo
                catalog = [
                    ...servicios.filter(s=>s.estados_id_estado_pk===1).map(s => ({...s, tipo: 'servicio', precio: s.precio, id: s.servicios_id_servicio_pk})),
                    ...productos.filter(p=>p.estados_id_estado_pk===1).map(p => ({...p, tipo: 'producto', precio: p.precio_unitario, id: p.producto_id_producto_pk}))
                ];
                filtrarCatalogo('servicio');

                // Llenar Direcciones (Filtrar por usuario si quieres, aqu√≠ muestro todas para demo o podr√≠as filtrar por currentUser.cedula si tuvieras relaci√≥n)
                const selectDir = document.getElementById('selectDireccion');
                selectDir.innerHTML = '<option value="">Selecciona ubicaci√≥n...</option>';
                
                // Filtro simple: mostrar direcciones asociadas al usuario actual
                const misDirecciones = direcciones.filter(d => d.usuarios_id_cedula_pk == currentUser.cedula);
                
                if(misDirecciones.length > 0) {
                    misDirecciones.forEach(d => {
                        selectDir.innerHTML += `<option value="${d.direcciones_id_direccion_pk}">${d.descripcion}</option>`;
                    });
                } else {
                    // Si no tiene, mostrar opci√≥n gen√©rica o todas (depende de tu l√≥gica de negocio)
                    selectDir.innerHTML += `<option value="" disabled>No tienes direcciones registradas (Contacta a soporte)</option>`;
                    // Fallback: Mostrar todas las p√∫blicas si existieran, o forzar creaci√≥n (fuera de alcance actual)
                    direcciones.forEach(d => {
                         selectDir.innerHTML += `<option value="${d.direcciones_id_direccion_pk}">ID ${d.direcciones_id_direccion_pk}: ${d.descripcion}</option>`;
                    });
                }

            } catch (e) { console.error(e); }
        }

        function filtrarCatalogo(tipo) {
            const div = document.getElementById('catalogContainer');
            div.innerHTML = catalog.filter(i => i.tipo === tipo).map(item => `
                <div class="item-card">
                    <div style="flex:1">
                        <h4>${item.nombre}</h4>
                        <small>${item.descripcion || ''}</small>
                        <div style="color: #ff4081; font-weight:bold;">‚Ç°${item.precio}</div>
                    </div>
                    <button class="btn-add" onclick="addToCart(${item.id}, '${item.tipo}')">+</button>
                </div>
            `).join('');
        }

        function addToCart(id, tipo) {
            const item = catalog.find(i => i.id === id && i.tipo === tipo);
            cart.push(item);
            renderCart();
        }

        function renderCart() {
            const div = document.getElementById('cartItems');
            if(cart.length === 0) {
                div.innerHTML = '<p style="color:#666; text-align:center; font-size:0.9rem;">Carrito vac√≠o</p>';
                document.getElementById('cartTotal').textContent = '‚Ç°0';
                return;
            }
            let total = 0;
            div.innerHTML = cart.map((item, idx) => {
                total += item.precio;
                return `<div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:5px;">
                    <span>${item.nombre}</span>
                    <span style="cursor:pointer; color:red;" onclick="cart.splice(${idx},1); renderCart()">x</span>
                </div>`;
            }).join('');
            document.getElementById('cartTotal').textContent = `‚Ç°${total}`;
        }

        async function realizarCheckout() {
            const fecha = document.getElementById('fecha').value;
            const inicio = document.getElementById('horaInicio').value;
            const fin = document.getElementById('horaFin').value;
            const dirId = document.getElementById('selectDireccion').value;

            if(!fecha || !inicio || !fin || !dirId) {
                alert("Por favor completa todos los campos: Fecha, Horas y Ubicaci√≥n.");
                return;
            }
            if(cart.length === 0) {
                alert("El carrito est√° vac√≠o.");
                return;
            }

            const payload = {
                clienteId: currentUser.cedula,
                fecha, horaInicio, horaFin,
                direccionId: dirId, // Enviamos el ID real
                items: cart,
                total: cart.reduce((acc, i) => acc + i.precio, 0)
            };

            try {
                const res = await fetch('http://localhost:3000/api/checkout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.success) {
                    alert("¬°Reserva creada con √©xito!");
                    cart = [];
                    renderCart();
                    mostrarSeccion('mis'); // Ir a historial
                } else {
                    alert("Error: " + data.error);
                }
            } catch(e) { alert("Error de conexi√≥n"); }
        }

        async function cargarMisReservas() {
            const div = document.getElementById('lista-mis-reservas');
            div.innerHTML = '<p style="text-align:center; color:#888;">Cargando historial...</p>';
            
            try {
                // 1. Obtener reservas
                const reservas = await fetch('http://localhost:3000/api/reservaciones').then(r => r.json());
                
                // DEBUG: Ver qu√© est√° llegando (puedes borrar esto luego)
                console.log("Usuario Actual:", currentUser.cedula);
                console.log("Primera Reserva (Ejemplo):", reservas[0]);

                // 2. FILTRADO ROBUSTO
                // Convertimos ambos a String y usamos trim() para evitar errores por espacios ocultos
                const miCedula = String(currentUser.cedula).trim();
                
                const mis = reservas.filter(r => {
                    // Nota: r.usuarios_id_cedula_pk viene en min√∫sculas por tu server.js
                    if (!r.usuarios_id_cedula_pk) return false; 
                    return String(r.usuarios_id_cedula_pk).trim() === miCedula;
                });
                
                // Ordenar por fecha m√°s reciente
                mis.sort((a,b) => new Date(b.fecha_reservacion) - new Date(a.fecha_reservacion));

                if(mis.length === 0) {
                    div.innerHTML = `
                        <div style="text-align:center; padding:40px; background:#252525; border-radius:10px;">
                            <p style="font-size:30px; margin-bottom:10px;">üì≠</p>
                            <p style="color:#aaa;">A√∫n no tienes reservaciones registradas.</p>
                            <p style="font-size:0.8rem; color:#666;">ID Usuario: ${miCedula}</p>
                            <button onclick="mostrarSeccion('nueva')" style="color:#ff4081; background:none; border:none; cursor:pointer; text-decoration:underline; margin-top:10px;">¬°Crea tu primera reserva!</button>
                        </div>`;
                    return;
                }

                div.innerHTML = mis.map(r => {
                    // Manejo seguro de fechas para visualizaci√≥n
                    let fechaStr = "Fecha pendiente";
                    if (r.fecha_reservacion) {
                        // Intentar parsear la fecha ISO
                        fechaStr = new Date(r.fecha_reservacion).toLocaleDateString('es-CR', { 
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                        });
                    }
                    
                    let estado = 'Desconocido';
                    let colorBadge = '#666';
                    
                    // Mapeo de IDs de estado
                    if(r.estados_id_estado_pk == 3) { estado = 'Pendiente'; colorBadge = '#ff9800'; } 
                    if(r.estados_id_estado_pk == 4) { estado = 'Confirmada'; colorBadge = '#4caf50'; } 
                    if(r.estados_id_estado_pk == 5) { estado = 'Cancelada'; colorBadge = '#f44336'; } 

                    // Bot√≥n cancelar
                    const btnCancelar = r.estados_id_estado_pk == 3 
                        ? `<button onclick="cancelarReserva(${r.reservaciones_id_reservacion_pk})" style="background:transparent; border:1px solid #f44336; color:#f44336; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;">Cancelar</button>` 
                        : '';

                    return `
                    <div class="reserva-card" style="background:#252525; padding:15px; margin-bottom:15px; border-radius:8px; border-left: 4px solid ${colorBadge}; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                                <h4 style="margin:0; color:white;">Reserva #${r.reservaciones_id_reservacion_pk}</h4>
                                <span style="background:${colorBadge}20; color:${colorBadge}; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:bold;">${estado}</span>
                            </div>
                            <p style="margin:0; color:#aaa; font-size:0.9rem; text-transform: capitalize;">üìÖ ${fechaStr}</p>
                            <small style="color:#666;">Ubicaci√≥n ID: ${r.direcciones_id_direccion_pk}</small>
                        </div>
                        <div>
                            ${btnCancelar}
                        </div>
                    </div>`;
                }).join('');

            } catch(e) {
                console.error("Error cargando historial:", e);
                div.innerHTML = '<p style="color:red;">Error cargando historial. Revisa la consola.</p>';
            }
        }

        window.cancelarReserva = async (id) => {
            if(!confirm("¬øSeguro que deseas cancelar esta reserva?")) return;
            try {
                await fetch(`http://localhost:3000/api/reservaciones/${id}`, {
                    method: 'DELETE'
                });
                alert("Reserva cancelada.");
                cargarMisReservas();
            } catch(e) { alert("Error al cancelar"); }
        };
    </script>
</body>
</html>