<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Registro | Pink Rentals</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="css/login-modern.css">
</head>
<body>

    <div class="container" id="container">
        <a href="index.html" class="close-login">
            <ion-icon name="close-outline"></ion-icon>
        </a>
        <div class="form-container sign-up-container">
            <form id="registerForm">
                <h2>Crear Cuenta</h2>
                <span>Usa tu cédula real para el registro</span>
                
                <div class="container-input">
                    <ion-icon name="card-outline"></ion-icon>
                    <input type="text" id="reg_cedula" placeholder="Cédula" required />
                </div>
                <div class="container-input">
                    <ion-icon name="person-outline"></ion-icon>
                    <input type="text" id="reg_nombre" placeholder="Nombre" required />
                </div>
                <div style="display:flex; gap:10px; width:100%">
                    <div class="container-input">
                        <input type="text" id="reg_apellido1" placeholder="1er Apellido" required />
                    </div>
                    <div class="container-input">
                        <input type="text" id="reg_apellido2" placeholder="2do Apellido" required />
                    </div>
                </div>
                
                <div class="container-input">
                    <ion-icon name="call-outline"></ion-icon>
                    <input type="text" id="reg_telefono" placeholder="Teléfono" required />
                </div>
                <div class="container-input">
                    <ion-icon name="lock-closed-outline"></ion-icon>
                    <input type="password" id="reg_password" placeholder="Contraseña" required />
                </div>

                <button type="submit">Registrarse</button>
                <p id="regError" class="error-msg">Error</p>
            </form>
        </div>

        <div class="form-container sign-in-container">
            <form id="loginForm">
                <h1>Iniciar Sesión</h1>
                <p>Bienvenido de nuevo a Pink Rentals</p>
                
                <div class="container-input">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    <input type="text" id="login_cedula" placeholder="Cédula" required />
                </div>
                <div class="container-input">
                    <ion-icon name="lock-closed-outline"></ion-icon>
                    <input type="password" id="login_password" placeholder="Contraseña" required />
                </div>
                
                <a href="#">¿Olvidaste tu contraseña?</a>
                <button type="submit">Ingresar</button>
                <p id="loginError" class="error-msg">Error</p>
            </form>
        </div>

        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-left">
                    <h1>¡Bienvenido!</h1>
                    <p>Si ya tienes cuenta con nosotros, inicia sesión aquí.</p>
                    <button class="ghost" id="signIn">Iniciar Sesión</button>
                </div>
                <div class="overlay-panel overlay-right">
                    <h1>¿Nuevo Aquí?</h1>
                    <p>Regístrate y comienza a reservar los mejores eventos.</p>
                    <button class="ghost" id="signUp">Registrarse</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // A. CONTROL DE ANIMACIÓN (Panel Deslizante)
        const signUpButton = document.getElementById('signUp');
        const signInButton = document.getElementById('signIn');
        const container = document.getElementById('container');

        signUpButton.addEventListener('click', () => container.classList.add("right-panel-active"));
        signInButton.addEventListener('click', () => container.classList.remove("right-panel-active"));

        // B. CONFIGURACIÓN API
        const API_URL = 'http://localhost:3000/api';

        // 1. LÓGICA DE LOGIN (CORREGIDA Y ROBUSTA)
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log("1. Botón presionado, intentando login...");

    // CORRECCIÓN 1: Usar los IDs correctos definidos en el HTML
    const cedula = document.getElementById('login_cedula').value;
    const password = document.getElementById('login_password').value;
    
    // CORRECCIÓN 2: El ID del mensaje de error en HTML es 'loginError'
    const errorMsg = document.getElementById('loginError');
    
    // CORRECCIÓN 3: El botón no tiene la clase .btn-login, lo buscamos por tipo
    const btnSubmit = e.target.querySelector('button[type="submit"]');

    // Limpiar UI
    errorMsg.style.display = 'none';
    btnSubmit.disabled = true;
    const textoOriginal = btnSubmit.innerText;
    btnSubmit.innerText = "Verificando...";

    try {
        console.log("2. Enviando datos:", { cedula }); 
        
        const res = await fetch('http://localhost:3000/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cedula, password })
        });

        const data = await res.json();

        if (data.success) {
            // Guardar usuario
            localStorage.setItem('pinkUser', JSON.stringify(data.user));
            
            // Redirección según rol
            if (data.user.rol === 10 || data.user.rol === 20) {
                window.location.href = 'index.html'; // O panel admin si tienes uno específico
            } else {
                window.location.href = 'index.html';
            }

        } else {
            throw new Error(data.message || 'Credenciales inválidas');
        }

    } catch (err) {
        console.error("ERROR:", err);
        errorMsg.style.display = 'block';
        errorMsg.textContent = err.message;
    } finally {
        // Reactivar botón siempre
        btnSubmit.disabled = false;
        btnSubmit.innerText = textoOriginal;
    }
});

        // 2. LÓGICA DE REGISTRO (CON DOBLE TRANSACCIÓN)
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorSpan = document.getElementById('regError');
            errorSpan.style.display = 'none'; // Limpiar error previo
            
            const registroData = {
                cedula: document.getElementById('reg_cedula').value,
                nombre: document.getElementById('reg_nombre').value,
                apellido1: document.getElementById('reg_apellido1').value,
                apellido2: document.getElementById('reg_apellido2').value,
                telefono: document.getElementById('reg_telefono').value,
                password: document.getElementById('reg_password').value
            };

            try {
                const response = await fetch(`${API_URL}/clientes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(registroData)
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || "Error al registrar");

                alert('¡Cuenta creada exitosamente! Ahora puedes iniciar sesión.');
                // Volver automáticamente al panel de login
                container.classList.remove("right-panel-active"); 
                document.getElementById('registerForm').reset();

            } catch (err) {
                console.error(err);
                errorSpan.textContent = err.message || "Error de conexión";
                errorSpan.style.display = 'block';
            }
        });
    </script>
</body>
</html>